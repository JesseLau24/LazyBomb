<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LazyBomb Task List</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .status-column {
            flex: 1;
            padding: 10px;
            background-color: #fefefe;
            border-radius: 10px;
            box-shadow: 0 0 4px rgba(0,0,0,0.1);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 400px;
            width: 100%;
        }
        .no-deadline-warning {
            color: orange;
            font-weight: bold;
            margin-left: 5px;
        }
        .email-content {
            display: none;
            white-space: pre-wrap;
            background-color: #f2f2f2;
            padding: 10px;
            border-radius: 6px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    {% macro status_class(status) %}
        {% set s = status|lower %}
        {% if s == 'to do' %}
            status-todo
        {% elif s == "i'm on it" or s == 'imonit' %}
            status-imonit
        {% elif s == 'finished' %}
            status-finished
        {% elif s == 'deleted' %}
            status-deleted
        {% else %}
            status-todo
        {% endif %}
    {% endmacro %}

    {% set statuses = ['to do', "I'm on it", 'finished', 'deleted'] %}

    <h1>üß® LazyBomb Task List</h1>

    <form action="/export_html" method="post">
        <button type="submit">üìÑ Export Static HTML Snapshot</button>
    </form>

    <div style="margin-bottom: 20px;">
        <button onclick="sortByDate()">üìÖ Sort by Deadline</button>
        <button onclick="sortByPriority()">üî• Sort by Priority</button>
    </div>

    <div class="date-group-container">
        {% set tasks_by_date = {} %}
        {% for task in tasks %}
            {% set date_key = task.due_date[:10] if task.due_date else 'No Deadline' %}
            {% if date_key not in tasks_by_date %}
                {% set _ = tasks_by_date.update({date_key: []}) %}
            {% endif %}
            {% set _ = tasks_by_date[date_key].append(task) %}
        {% endfor %}

        {% for date_str, group_tasks in tasks_by_date|dictsort %}
        <div class="date-group">
            <h2>{{ date_str }}</h2>
            <div class="status-row">
                {% for col in statuses %}
                <div class="status-column">
                    <h3>{{ col|capitalize }}</h3>
                    <ul>
                        {% for task in group_tasks if task.status|lower == col|lower %}
                        <li class="{{ status_class(task.status) }}"
                            data-due="{{ task.due_date or '9999-12-31T23:59' }}"
                            data-priority="{{ task.priority or 'normal' }}">
                            <div class="task-summary">
                                <strong>{{ task.task or 'Untitled Task' | e }}</strong>
                                <button class="show-email-btn" onclick="toggleEmailContent(event, this)">+</button>
                            </div>
                            <div class="email-content">{{ task.email_content or '' }}</div>
                            üìÖ <em>Due:</em> {{ task.due_date or 'No deadline' | e }}
                            {% if not task.due_date %}<span class="no-deadline-warning">‚ö†Ô∏è</span>{% endif %}
                            <br>
                            üî• <em>Priority:</em> {{ task.priority|capitalize if task.priority else 'Normal' }} <br>
                            üßë <em>Assigned by:</em> {{ task.assigner or 'Unassigned' | e }}<br>
                            üí¨ <em>Comments:</em> {{ task.comments or 'None' | e }}<br>
                            <label>Status:
                                <select 
                                    data-task="{{ task.task | e }}" 
                                    data-prev="{{ task.status }}"
                                    onchange="updateStatus(this)">
                                    <option value="to do" {% if task.status == 'to do' %}selected{% endif %}>to do</option>
                                    <option value="I'm on it" {% if task.status == "I'm on it" %}selected{% endif %}>I'm on it</option>
                                    <option value="finished" {% if task.status == 'finished' %}selected{% endif %}>finished</option>
                                </select>
                            </label>
                            <button onclick='openEditModal({{ task | tojson | safe }})'>‚úèÔ∏è Edit</button>
                            {% if task.status == 'deleted' %}
                            <button onclick="restoreTask('{{ task.task }}')">‚ôªÔ∏è Restore</button>
                            <button onclick="deleteForever('{{ task.task }}')">üß® Delete Forever</button>
                            {% else %}
                            <button onclick="deleteTask('{{ task.task }}')">üóëÔ∏è Delete</button>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="modal" id="editModal">
        <div class="modal-content">
            <h3>Edit Task</h3>
            <input type="hidden" id="original-task-name">
            <label>Task: <input id="edit-task-name"></label><br><br>
            <label>Due Date: <input type="datetime-local" id="edit-due-date"></label><br><br>
            <label>Priority:
                <select id="edit-priority">
                    <option value="">(unset)</option>
                    <option value="high">high</option>
                    <option value="medium">medium</option>
                    <option value="low">low</option>
                    <option value="it's complicated">it's complicated</option>
                </select>
            </label><br><br>
            <label>Assigner: <input id="edit-assigner"></label><br><br>
            <label>Comments:<br>
                <textarea id="edit-comments" rows="3" style="width: 100%;"></textarea>
            </label><br>
            <button onclick="submitEditForm()">üíæ Save</button>
            <button onclick="document.getElementById('editModal').style.display='none'">‚ùå Cancel</button>
        </div>
    </div>

    <script>
        function toggleEmailContent(event, button) {
            event.preventDefault();
            const content = button.parentElement.nextElementSibling;
            if (content.style.display === 'none') {
                content.style.display = 'block';
                button.textContent = '-';
            } else {
                content.style.display = 'none';
                button.textContent = '+';
            }
        }

        async function updateStatus(selectElem) {
            const taskName = selectElem.getAttribute('data-task');
            const newStatus = selectElem.value;
            try {
                const res = await fetch('/update_status', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({task: taskName, status: newStatus})
                });
                const data = await res.json();
                if (!res.ok) {
                    alert('‚ùå Failed to update task status: ' + data.error);
                    selectElem.value = selectElem.getAttribute('data-prev');
                } else {
                    selectElem.setAttribute('data-prev', newStatus);
                    updateTaskStyle(selectElem.closest('li'), newStatus);
                }
            } catch (err) {
                alert('‚ö†Ô∏è Error updating task status: ' + err.message);
                selectElem.value = selectElem.getAttribute('data-prev');
            }
        }

        function updateTaskStyle(liElem, status) {
            liElem.classList.remove('status-todo', 'status-imonit', 'status-finished');
            if (status.toLowerCase() === 'to do') liElem.classList.add('status-todo');
            else if (status.toLowerCase() === "i'm on it") liElem.classList.add('status-imonit');
            else if (status.toLowerCase() === 'finished') liElem.classList.add('status-finished');
        }

        function sortTasks(compareFn) {
            document.querySelectorAll('.date-group').forEach(dateGroup => {
                dateGroup.querySelectorAll('.status-column').forEach(statusCol => {
                    const ul = statusCol.querySelector('ul');
                    const items = Array.from(ul.children);
                    items.sort(compareFn);
                    items.forEach(item => ul.appendChild(item));
                });
            });
        }

        function sortByDate() {
            sortTasks((a, b) => new Date(a.dataset.due ?? '') - new Date(b.dataset.due ?? ''));
        }

        function sortByPriority() {
            const priorityOrder = {
                'high': 1,
                'medium': 2,
                'low': 3,
                "it's complicated": 4,
                '': 5,
                'normal': 5
            };
            sortTasks((a, b) => {
                const priA = priorityOrder[(a.dataset.priority ?? '').toLowerCase()] || 5;
                const priB = priorityOrder[(b.dataset.priority ?? '').toLowerCase()] || 5;
                return priA - priB;
            });
        }

        async function deleteTask(taskName) {
            if (!confirm(`Are you sure you want to delete "${taskName}"?`)) return;
            await fetch('/delete_task', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({task: taskName})
            });
            location.reload();
        }

        async function restoreTask(taskName) {
            await fetch('/restore_task', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({task: taskName})
            });
            location.reload();
        }

        async function deleteForever(taskName) {
            if (!confirm(`üö® Permanently delete "${taskName}"? This cannot be undone.`)) return;
            await fetch('/delete_forever', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({task: taskName})
            });
            location.reload();
        }

        function openEditModal(task) {
            document.getElementById('edit-task-name').value = task.task || '';
            document.getElementById('edit-due-date').value = task.due_date || '';
            document.getElementById('edit-priority').value = task.priority || '';
            document.getElementById('edit-assigner').value = task.assigner || '';
            document.getElementById('edit-comments').value = task.comments || '';
            document.getElementById('original-task-name').value = task.task;
            document.getElementById('editModal').style.display = 'flex';
        }

        async function submitEditForm() {
            const originalTask = document.getElementById('original-task-name').value;
            const updates = {
                task: document.getElementById('edit-task-name').value,
                due_date: document.getElementById('edit-due-date').value,
                deadline: document.getElementById('edit-due-date').value,
                priority: document.getElementById('edit-priority').value,
                assigner: document.getElementById('edit-assigner').value,
                comments: document.getElementById('edit-comments').value
            };
            await fetch('/edit_task', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({task: originalTask, updates})
            });
            location.reload();
        }
    </script>
</body>
</html>